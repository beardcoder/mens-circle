---
import Base from '@/layouts/Base.astro';
import { getTestimonials } from '@/lib/payload';

const testimonials = await getTestimonials();
const cmsUrl = import.meta.env.CMS_URL || 'http://localhost:3001';
---

<Base title="Erfahrungsberichte" description="Was Teilnehmer über den Männerkreis Niederbayern/Straubing sagen.">
  <section class="hero">
    <div class="hero__bg"></div>
    <div class="hero__circles" aria-hidden="true">
      <div class="hero__circle hero__circle--1"></div>
      <div class="hero__circle hero__circle--2"></div>
    </div>
    <div class="container">
      <div class="hero__content">
        <p class="hero__label">Stimmen</p>
        <h1 class="hero__title"><span class="hero__title-line">Erfahrungsberichte</span></h1>
        <div class="hero__bottom">
          <p class="hero__description">
            Was Teilnehmer über den Männerkreis sagen.
          </p>
        </div>
      </div>
    </div>
  </section>

  <section class="testimonials-page-section">
    <div class="container">
      {testimonials.length > 0 ? (
        <div class="testimonials-page__grid stagger-children">
          {testimonials.map((t) => (
            <div class="testimonial-card fade-in">
              <div class="testimonial-card__quote-icon" aria-hidden="true">»</div>
              <blockquote class="testimonial-card__quote">
                <p>{t.content}</p>
              </blockquote>
              <div class="testimonial-card__author">
                <span class="testimonial-card__name">{t.authorName || 'Anonym'}</span>
                {t.authorRole && <span class="testimonial-card__role">{t.authorRole}</span>}
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="testimonials-page__empty fade-in">
          <p>Noch keine Erfahrungsberichte vorhanden.</p>
        </div>
      )}
    </div>
  </section>

  <section class="testimonial-submit-section" id="teilen">
    <div class="container container--narrow">
      <div class="testimonial-submit__content fade-in">
        <p class="eyebrow">Deine Erfahrung</p>
        <h2 class="section-title">Erfahrung <span class="text-italic">teilen</span></h2>
        <p class="testimonial-submit__text">
          Warst du schon bei einem Männerkreis dabei? Teile deine Erfahrung mit anderen.
          Dein Bericht wird nach Prüfung veröffentlicht.
        </p>
      </div>
      <form id="testimonialForm" class="testimonial-submit__form fade-in">
        <div class="form-group">
          <label for="testimonialContent">Dein Erfahrungsbericht *</label>
          <textarea
            id="testimonialContent"
            name="content"
            required
            rows="5"
            placeholder="Was hat dich am Männerkreis bewegt?"
          ></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="testimonialName">
              Name <span class="form-label-optional">(optional)</span>
            </label>
            <input
              type="text"
              id="testimonialName"
              name="authorName"
              placeholder="Dein Name"
            />
          </div>
          <div class="form-group">
            <label for="testimonialRole">
              Rolle <span class="form-label-optional">(optional)</span>
            </label>
            <input
              type="text"
              id="testimonialRole"
              name="authorRole"
              placeholder="z.B. Teilnehmer seit 2024"
            />
          </div>
        </div>
        <div class="form-group">
          <label for="testimonialEmail">E-Mail *</label>
          <input
            type="email"
            id="testimonialEmail"
            name="email"
            required
            placeholder="deine@email.de"
            autocomplete="email"
          />
          <span class="form-helper">Nur für Rückfragen, wird nicht veröffentlicht.</span>
        </div>
        <button type="submit" class="btn btn--primary btn--large">Erfahrung teilen</button>
        <div id="testimonialMessage" class="form-message"></div>
      </form>
    </div>
  </section>
</Base>

<script define:vars={{ cmsUrl }}>
  const form = document.getElementById('testimonialForm');
  const message = document.getElementById('testimonialMessage');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);

    try {
      const res = await fetch(`${cmsUrl}/api/submit-testimonial`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          content: formData.get('content'),
          authorName: formData.get('authorName') || undefined,
          authorRole: formData.get('authorRole') || undefined,
          email: formData.get('email'),
        }),
      });
      const data = await res.json();

      if (message) {
        message.textContent = data.message || data.error;
        message.className = `form-message form-message--${data.success ? 'success' : 'error'}`;
      }
      if (data.success) form.reset();
    } catch {
      if (message) {
        message.textContent = 'Ein Fehler ist aufgetreten. Bitte versuche es später erneut.';
        message.className = 'form-message form-message--error';
      }
    }
  });
</script>

<style>
  .testimonials-page-section {
    padding: var(--space-2xl) 0;
  }

  .testimonials-page__grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 20rem), 1fr));
    gap: var(--space-lg);
  }

  .testimonials-page__empty {
    text-align: center;
    padding: var(--space-2xl) 0;
    color: var(--color-text-secondary);
  }

  .testimonial-submit-section {
    padding: var(--space-2xl) 0;
    background: var(--color-surface);
  }

  .testimonial-submit__content {
    text-align: center;
    margin-block-end: var(--space-xl);
  }

  .testimonial-submit__text {
    max-inline-size: 36rem;
    margin-inline: auto;
    color: var(--color-text-secondary);
  }

  .testimonial-submit__form {
    max-inline-size: 36rem;
    margin-inline: auto;
  }
</style>
