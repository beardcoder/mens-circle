---
import Base from '@/layouts/Base.astro';
import Hero from '@/components/blocks/Hero.astro';
import Intro from '@/components/blocks/Intro.astro';
import ValueItems from '@/components/blocks/ValueItems.astro';
import Moderator from '@/components/blocks/Moderator.astro';
import JourneySteps from '@/components/blocks/JourneySteps.astro';
import Testimonials from '@/components/blocks/Testimonials.astro';
import FAQ from '@/components/blocks/FAQ.astro';
import Newsletter from '@/components/blocks/Newsletter.astro';
import CTA from '@/components/blocks/CTA.astro';
import WhatsAppCommunity from '@/components/blocks/WhatsAppCommunity.astro';
import TextSection from '@/components/blocks/TextSection.astro';
import { getPage, getTestimonials } from '@/lib/payload';
import type { ContentBlock } from '@/lib/payload';

const { slug } = Astro.params;
if (!slug) return Astro.redirect('/');

const page = await getPage(slug);
if (!page) {
  return new Response(null, { status: 404 });
}

const cmsUrl = import.meta.env.CMS_URL || 'http://localhost:3001';
const ogImageUrl = page.meta?.ogImage ? `${cmsUrl}${page.meta.ogImage.url}` : undefined;

let testimonials: Awaited<ReturnType<typeof getTestimonials>> = [];
const hasTestimonialsBlock = page.content?.some((b: ContentBlock) => b.blockType === 'testimonials');
if (hasTestimonialsBlock) {
  testimonials = await getTestimonials();
}

const blocks = page.content || [];
---

<Base
  title={page.meta?.metaTitle || page.title}
  description={page.meta?.metaDescription}
  ogImage={ogImageUrl}
>
  {
    blocks.map((block: ContentBlock) => {
      switch (block.blockType) {
        case 'hero':
          return (
            <Hero
              label={block.label}
              title={block.title}
              description={block.description}
              ctaText={block.ctaText}
              ctaLink={block.ctaLink}
              backgroundImage={block.backgroundImage}
            />
          );
        case 'intro':
          return <Intro eyebrow={block.eyebrow} title={block.title} text={block.text} quote={block.quote} values={block.values} />;
        case 'valueItems':
          return <ValueItems eyebrow={block.eyebrow} title={block.title} items={block.items} />;
        case 'moderator':
          return <Moderator eyebrow={block.eyebrow} name={block.name} bio={block.bio} quote={block.quote} photo={block.photo} />;
        case 'journeySteps':
          return <JourneySteps eyebrow={block.eyebrow} title={block.title} subtitle={block.subtitle} steps={block.steps} />;
        case 'testimonials':
          return <Testimonials eyebrow={block.eyebrow} title={block.title} subtitle={block.subtitle} testimonials={testimonials} />;
        case 'faq':
          return <FAQ eyebrow={block.eyebrow} title={block.title} intro={block.intro} items={block.items} />;
        case 'newsletter':
          return <Newsletter eyebrow={block.eyebrow} title={block.title} text={block.text} />;
        case 'cta':
          return (
            <CTA
              eyebrow={block.eyebrow}
              title={block.title}
              text={block.text}
              buttonText={block.buttonText}
              buttonLink={block.buttonLink}
            />
          );
        case 'whatsappCommunity':
          return <WhatsAppCommunity eyebrow={block.eyebrow} title={block.title} text={block.text} link={block.link} hint={block.hint} />;
        case 'textSection':
          return <TextSection eyebrow={block.eyebrow} title={block.title} content={block.content} />;
        default:
          return null;
      }
    })
  }

  {
    blocks.length === 0 && (
      <section class="legal-section">
        <div class="container container--narrow">
          <h1 class="legal__title">{page.title}</h1>
        </div>
      </section>
    )
  }
</Base>
