---
import Base from '@/layouts/Base.astro';
import Hero from '@/components/blocks/Hero.astro';
import Intro from '@/components/blocks/Intro.astro';
import ValueItems from '@/components/blocks/ValueItems.astro';
import Moderator from '@/components/blocks/Moderator.astro';
import JourneySteps from '@/components/blocks/JourneySteps.astro';
import Testimonials from '@/components/blocks/Testimonials.astro';
import FAQ from '@/components/blocks/FAQ.astro';
import Newsletter from '@/components/blocks/Newsletter.astro';
import CTA from '@/components/blocks/CTA.astro';
import WhatsAppCommunity from '@/components/blocks/WhatsAppCommunity.astro';
import TextSection from '@/components/blocks/TextSection.astro';
import { getSettings, getPage, getTestimonials } from '@/lib/payload';
import type { ContentBlock } from '@/lib/payload';

let settings = null;
let page = null;
let testimonials: Awaited<ReturnType<typeof getTestimonials>> = [];

try {
  settings = await getSettings();

  const homepageSlug = typeof settings?.homepage === 'object' && settings.homepage ? settings.homepage.slug : 'home';

  page = await getPage(homepageSlug);
  testimonials = await getTestimonials();
} catch (e) {
  console.error('CMS Error:', e);
}

const blocks = page?.content || [];
---

<Base>
  {
    blocks.map((block: ContentBlock) => {
      switch (block.blockType) {
        case 'hero':
          return (
            <Hero
              label={block.label}
              title={block.title}
              description={block.description}
              ctaText={block.ctaText}
              ctaLink={block.ctaLink}
              backgroundImage={block.backgroundImage}
            />
          );
        case 'intro':
          return <Intro eyebrow={block.eyebrow} title={block.title} text={block.text} quote={block.quote} values={block.values} />;
        case 'valueItems':
          return <ValueItems eyebrow={block.eyebrow} title={block.title} items={block.items} />;
        case 'moderator':
          return <Moderator eyebrow={block.eyebrow} name={block.name} bio={block.bio} quote={block.quote} photo={block.photo} />;
        case 'journeySteps':
          return <JourneySteps eyebrow={block.eyebrow} title={block.title} subtitle={block.subtitle} steps={block.steps} />;
        case 'testimonials':
          return <Testimonials eyebrow={block.eyebrow} title={block.title} subtitle={block.subtitle} testimonials={testimonials} />;
        case 'faq':
          return <FAQ eyebrow={block.eyebrow} title={block.title} intro={block.intro} items={block.items} />;
        case 'newsletter':
          return <Newsletter eyebrow={block.eyebrow} title={block.title} text={block.text} />;
        case 'cta':
          return (
            <CTA
              eyebrow={block.eyebrow}
              title={block.title}
              text={block.text}
              buttonText={block.buttonText}
              buttonLink={block.buttonLink}
            />
          );
        case 'whatsappCommunity':
          return <WhatsAppCommunity eyebrow={block.eyebrow} title={block.title} text={block.text} link={block.link} hint={block.hint} />;
        case 'textSection':
          return <TextSection eyebrow={block.eyebrow} title={block.title} content={block.content} />;
        default:
          return null;
      }
    })
  }

  {
    blocks.length === 0 && (
      <section class="hero">
        <div class="hero__bg" />
        <div class="hero__circles" aria-hidden="true">
          <div class="hero__circle hero__circle--1" />
          <div class="hero__circle hero__circle--2" />
          <div class="hero__circle hero__circle--3" />
        </div>
        <div class="container">
          <div class="hero__content">
            <p class="hero__label">Willkommen</p>
            <h1 class="hero__title">
              <span class="hero__title-line">Männerkreis Niederbayern</span>
            </h1>
            <div class="hero__bottom">
              <p class="hero__description">
                Ein Raum für echte Begegnung unter Männern. Erstelle Inhalte im CMS unter{' '}
                <a href={`${import.meta.env.CMS_URL || 'http://localhost:3001'}/admin`}>/admin</a>.
              </p>
            </div>
          </div>
        </div>
      </section>
    )
  }
</Base>
