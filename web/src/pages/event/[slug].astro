---
import Base from '@/layouts/Base.astro'
import { getEvent, getEventRegistrationCount } from '@/lib/payload'

const { slug } = Astro.params
if (!slug) return Astro.redirect('/event')

const event = await getEvent(slug)
if (!event) return Astro.redirect('/event')

const registrationCount = await getEventRegistrationCount(event.id)
const availableSpots = event.maxParticipants - registrationCount
const isFull = availableSpots <= 0
const isPast = new Date(event.eventDate) < new Date()
const eventDate = new Date(event.eventDate)
const dateStr = eventDate.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' })
const dateLong = eventDate.toLocaleDateString('de-DE', { day: '2-digit', month: 'long', year: 'numeric' })
const weekday = eventDate.toLocaleDateString('de-DE', { weekday: 'long' })

const cmsUrl = import.meta.env.CMS_URL || 'http://localhost:3001'
---

<Base title={`${event.title} am ${eventDate.toLocaleDateString('de-DE')}`} description={`Treffen des Männerkreis am ${dateStr} in ${event.location}`}>

  <!-- Event Hero -->
  <section class="hero event-hero">
    <div class="hero__bg"></div>
    <div class="hero__circles" aria-hidden="true">
      <div class="hero__circle hero__circle--1"></div>
      <div class="hero__circle hero__circle--2"></div>
      <div class="hero__circle hero__circle--3"></div>
      <div class="hero__circle hero__circle--4"></div>
    </div>
    <div class="container">
      <div class="hero__content">
        <p class="hero__label">{isPast ? 'Vergangenes Treffen' : 'Nächstes Treffen'}</p>
        <h1 class="hero__title"><span class="hero__title-line">{event.title}</span></h1>
        <div class="hero__bottom">
          <p class="hero__description">{weekday}, {eventDate.toLocaleDateString('de-DE')} · {event.startTime} Uhr · {event.location}</p>
          {!isPast && (
            <div class="hero__cta fade-in-delay-2">
              <a href="#anmeldung" class="btn btn--primary btn--large">Jetzt anmelden</a>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- Registration Section -->
  <section class="event-register-section" id="anmeldung">
    <div class="event-register__layout">
      <div class="event-register__content fade-in">
        <div class="event-register__circles" aria-hidden="true">
          <div class="event-register__circle event-register__circle--1"></div>
          <div class="event-register__circle event-register__circle--2"></div>
        </div>
        {isPast ? (
          <>
            <p class="eyebrow eyebrow--secondary">Rückblick</p>
            <h2 class="section-title section-title--lg section-title--light event-register__title">
              Dieses Treffen <br /><span class="text-italic">hat stattgefunden</span>
            </h2>
          </>
        ) : (
          <>
            <p class="eyebrow eyebrow--secondary">Sei dabei</p>
            <h2 class="section-title section-title--lg section-title--light event-register__title">
              Sichere dir <br /><span class="text-italic">deinen Platz</span>
            </h2>
            <p class="event-register__spots">
              {isFull ? (
                <span class="event-register__spots-full">Ausgebucht</span>
              ) : (
                <>
                  <span class="event-register__spots-available">{availableSpots}</span>
                  <span>von {event.maxParticipants} Plätzen frei</span>
                </>
              )}
            </p>
          </>
        )}
      </div>

      <div class="event-register__form-wrap fade-in fade-in-delay-1">
        {isPast ? (
          <div class="event-register__past-info">
            <p class="event-register__past-text">Dieses Treffen liegt in der Vergangenheit. Eine Anmeldung ist nicht mehr möglich.</p>
            <p class="event-register__past-text">Möchtest du beim nächsten Männerkreis dabei sein? Dann trag dich in unseren Newsletter ein.</p>
            <a href="/#newsletter" class="btn btn--primary btn--large">Zum Newsletter anmelden</a>
          </div>
        ) : (
          <form id="registrationForm" class="event-register__form" autocomplete="on">
            <input type="hidden" name="event_id" value={event.id} />
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">Vorname</label>
                <input type="text" id="firstName" name="first_name" placeholder="Dein Vorname" required autocomplete="given-name" />
              </div>
              <div class="form-group">
                <label for="lastName">Nachname</label>
                <input type="text" id="lastName" name="last_name" placeholder="Dein Nachname" required autocomplete="family-name" />
              </div>
            </div>
            <div class="form-group">
              <label for="email">E-Mail</label>
              <input type="email" id="email" name="email" placeholder="deine@email.de" required autocomplete="email" inputmode="email" />
            </div>
            <div class="form-group">
              <label for="phone">Handynummer <span class="form-label-optional">(optional)</span></label>
              <input type="tel" id="phone" name="phone_number" placeholder="+49 170 1234567" autocomplete="tel" inputmode="tel" />
              <span class="form-helper">Für Erinnerungen per SMS am Veranstaltungstag</span>
            </div>
            <label class="form-checkbox">
              <input type="checkbox" name="privacy" required />
              <span>Ich habe die <a href="/datenschutz" target="_blank">Datenschutzerklärung</a> gelesen und stimme der Verarbeitung meiner Daten zu.</span>
            </label>
            <button type="submit" class="btn btn--primary btn--large event-register__submit" disabled={isFull}>
              {isFull ? 'Ausgebucht' : 'Verbindlich anmelden'}
            </button>
            <div id="registrationMessage" class="form-message"></div>
          </form>
        )}
      </div>
    </div>
  </section>

  <!-- Event Info Section -->
  <section class="event-info-section">
    <div class="event-info__bg-text" aria-hidden="true">TERMIN</div>
    <div class="container">
      <div class="event-info__grid stagger-children">
        <div class="event-info__card event-info__card--date">
          <div class="event-info__card-circle" aria-hidden="true"></div>
          <div class="event-info__card-content">
            <h3>Datum</h3>
            <p class="event-info__card-value">{weekday}</p>
            <p class="event-info__card-sub">{dateLong}</p>
          </div>
        </div>
        <div class="event-info__card event-info__card--time">
          <div class="event-info__card-circle" aria-hidden="true"></div>
          <div class="event-info__card-content">
            <h3>Uhrzeit</h3>
            <p class="event-info__card-value">{event.startTime} Uhr</p>
            <p class="event-info__card-sub">bis {event.endTime} Uhr</p>
          </div>
        </div>
        <div class="event-info__card event-info__card--location">
          <div class="event-info__card-circle" aria-hidden="true"></div>
          <div class="event-info__card-content">
            <h3>Ort</h3>
            <p class="event-info__card-value">{event.location}</p>
            <p class="event-info__card-sub">Genaue Adresse nach Anmeldung</p>
          </div>
        </div>
        <div class="event-info__card event-info__card--participants">
          <div class="event-info__card-circle" aria-hidden="true"></div>
          <div class="event-info__card-content">
            <h3>Teilnehmer</h3>
            <p class="event-info__card-value">Max. {event.maxParticipants}</p>
            <p class="event-info__card-sub">{event.costBasis}</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Event Description -->
  <section class="event-about-section">
    <div class="event-about__layout">
      <div class="event-about__content fade-in">
        <p class="eyebrow">Über das Treffen</p>
        <h2 class="section-title section-title--lg event-about__title">
          Ein Raum für <br /><span class="text-italic">echte Begegnung</span>
        </h2>
        <div class="event-about__text" set:html={event.description.replace(/\n/g, '<br />')} />
      </div>
      <div class="event-about__visual fade-in fade-in-delay-1">
        <div class="event-about__quote-area">
          <div class="event-about__circles" aria-hidden="true">
            <div class="event-about__circle event-about__circle--1"></div>
            <div class="event-about__circle event-about__circle--2"></div>
            <div class="event-about__circle event-about__circle--3"></div>
          </div>
          <p class="event-about__quote">
            »Gemeinsam<br /><span class="text-italic">wachsen</span>,<br />einander<br /><span class="text-italic">stärken</span>«
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Final CTA -->
  <section class="event-cta-section">
    <div class="event-cta__circles" aria-hidden="true">
      <div class="event-cta__circle event-cta__circle--1"></div>
      <div class="event-cta__circle event-cta__circle--2"></div>
    </div>
    <div class="container">
      <div class="event-cta__content fade-in">
        {isPast ? (
          <>
            <p class="eyebrow">Interesse geweckt?</p>
            <h2 class="section-title event-cta__title">Bleib <span class="text-italic">informiert</span></h2>
            <a href="/#newsletter" class="btn btn--primary btn--large">Newsletter abonnieren</a>
          </>
        ) : (
          <>
            <p class="eyebrow">Bereit?</p>
            <h2 class="section-title event-cta__title">Melde dich <span class="text-italic">jetzt</span> an</h2>
            <a href="#anmeldung" class="btn btn--primary btn--large">Zur Anmeldung</a>
          </>
        )}
      </div>
    </div>
  </section>
</Base>

<script define:vars={{ cmsUrl, eventId: event.id }}>
  const form = document.getElementById('registrationForm')
  const message = document.getElementById('registrationMessage')

  form?.addEventListener('submit', async (e) => {
    e.preventDefault()
    const formData = new FormData(form)

    try {
      const res = await fetch(`${cmsUrl}/api/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          firstName: formData.get('first_name'),
          lastName: formData.get('last_name'),
          email: formData.get('email'),
          phone: formData.get('phone_number'),
          eventId: eventId,
        }),
      })
      const data = await res.json()

      if (message) {
        message.textContent = data.message || data.error
        message.className = `form-message form-message--${data.success ? 'success' : 'error'}`
      }
      if (data.success) {
        form.reset()
        const submitBtn = form.querySelector('button[type="submit"]')
        if (submitBtn) {
          submitBtn.textContent = 'Angemeldet ✓'
          submitBtn.disabled = true
        }
      }
    } catch {
      if (message) {
        message.textContent = 'Ein Fehler ist aufgetreten. Bitte versuche es später erneut.'
        message.className = 'form-message form-message--error'
      }
    }
  })
</script>
