---
interface Props {
  eyebrow?: string;
  title?: string;
  text?: string;
}

const { eyebrow, title, text } = Astro.props;
const cmsUrl = import.meta.env.CMS_URL || 'http://localhost:3001';
---

<section class="section newsletter-section" id="newsletter" aria-labelledby="newsletter-title">
  <div class="container">
    <div class="newsletter__layout fade-in">
      <div class="newsletter__content">
        {eyebrow && <p class="eyebrow eyebrow--secondary">{eyebrow}</p>}

        <h2 class="section-title newsletter__title" id="newsletter-title" set:html={title || 'Bleib informiert'}></h2>

        {text && <p class="newsletter__text">{text}</p>}
      </div>

      <div class="newsletter__form-wrapper">
        <form id="newsletterForm" class="newsletter__form" aria-label="Newsletter-Anmeldung">
          <label for="newsletter-email" class="sr-only">E-Mail-Adresse</label>
          <input
            type="email"
            id="newsletter-email"
            name="email"
            placeholder="Deine E-Mail-Adresse"
            required
            class="newsletter__input"
            autocomplete="email"
            inputmode="email"
          />
          <button type="submit" class="btn btn--primary">
            Anmelden
          </button>
          <div id="newsletterMessage" role="status" aria-live="polite"></div>
        </form>
      </div>
    </div>
  </div>
</section>

<script define:vars={{ cmsUrl }}>
  const form = document.getElementById('newsletterForm');
  const message = document.getElementById('newsletterMessage');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const email = formData.get('email');

    try {
      const res = await fetch(`${cmsUrl}/api/subscribe`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });
      const data = await res.json();

      if (message) {
        message.textContent = data.message || data.error;
        message.className = `form-message form-message--${data.success ? 'success' : 'error'}`;
      }
      if (data.success) form.reset();
    } catch {
      if (message) {
        message.textContent = 'Ein Fehler ist aufgetreten. Bitte versuche es sp√§ter erneut.';
        message.className = 'form-message form-message--error';
      }
    }
  });
</script>
