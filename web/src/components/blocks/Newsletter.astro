---
interface Props {
  eyebrow?: string;
  title?: string;
  text?: string;
}

const { eyebrow, title, text } = Astro.props;
const cmsUrl = import.meta.env.CMS_URL || 'http://localhost:3001';
---

<section class="newsletter-section" id="newsletter">
  <div class="newsletter__layout">
    <div class="newsletter__content fade-in">
      {eyebrow && <p class="eyebrow">{eyebrow}</p>}
      <h2 class="section-title">{title || 'Bleib informiert'}</h2>
      {text && <p class="newsletter__text">{text}</p>}
    </div>
    <div class="newsletter__form-wrap fade-in fade-in-delay-1">
      <form id="newsletterForm" class="newsletter-form">
        <div class="newsletter-form__row">
          <input
            type="email"
            name="email"
            placeholder="Deine E-Mail-Adresse"
            required
            autocomplete="email"
            class="newsletter-form__input"
          />
          <button type="submit" class="btn btn--primary newsletter-form__submit"> Anmelden </button>
        </div>
        <div id="newsletterMessage" class="form-message"></div>
      </form>
    </div>
  </div>
</section>

<script define:vars={{ cmsUrl }}>
  const form = document.getElementById('newsletterForm');
  const message = document.getElementById('newsletterMessage');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const email = formData.get('email');

    try {
      const res = await fetch(`${cmsUrl}/api/subscribe`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });
      const data = await res.json();

      if (message) {
        message.textContent = data.message || data.error;
        message.className = `form-message form-message--${data.success ? 'success' : 'error'}`;
      }
      if (data.success) form.reset();
    } catch {
      if (message) {
        message.textContent = 'Ein Fehler ist aufgetreten. Bitte versuche es sp√§ter erneut.';
        message.className = 'form-message form-message--error';
      }
    }
  });
</script>
