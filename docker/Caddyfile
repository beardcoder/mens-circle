{
    # Global options
    auto_https off
    admin :2019

    # Logging
    log {
        level ERROR
    }

    # Order matters - ensure static files are handled before PHP
    order file_server before php_server
}

:80 {
    # Set root to public directory
    root * /app/public

    # Enable compression (Brotli is automatically used if client supports it)
    encode zstd gzip

    # Fonts - immutable, versioned files
    @fonts {
        file
        path *.woff *.woff2 *.ttf *.eot *.otf
    }
    handle @fonts {
        file_server
        header {
            Cache-Control "public, max-age=31536000, immutable"
            Access-Control-Allow-Origin "*"
        }
    }

    # Vite build assets - immutable, hash-based versioning
    @vite_assets {
        file
        path /build/*
    }
    handle @vite_assets {
        file_server
        header {
            Cache-Control "public, max-age=31536000, immutable"
        }
    }

    # Images - long cache with revalidation
    @images {
        file
        path *.jpg *.jpeg *.png *.gif *.webp *.avif *.svg *.ico
    }
    handle @images {
        file_server
        header {
            Cache-Control "public, max-age=2592000, stale-while-revalidate=604800"
        }
    }

    # CSS and JS (non-Vite) - medium cache with revalidation
    @assets {
        file
        path *.css *.js
    }
    handle @assets {
        file_server
        header {
            Cache-Control "public, max-age=604800, stale-while-revalidate=86400"
        }
    }

    # Handle all PHP requests through FrankenPHP
    php_server {
        resolve_root_symlink
    }

    # Security headers (applied to all responses)
    header {
        # Security
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"

        # Performance hints
        X-DNS-Prefetch-Control "on"

        # Remove server header
        -Server
    }

    # Health check endpoint
    respond /up 200

    # Logs
    log {
        output stderr
        format console
    }
}
